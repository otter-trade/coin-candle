# 模拟持仓模块(mock_trade)

简化持仓模型。
每次更新当前需要的持仓的状态，然后系统会帮助下单并计算应得收入。

更新仓位状态
这种方式的好处在于，每次更新持仓时都可以动态的调整杠杆倍率，持仓比率等。

然后持仓结果可以同步给交易所完成实盘，若不同步给交易所，则可以当做回测模拟。

## 收益和收益率计算

```txt

计算收益率的公式：

收益率 = (平仓时的价格 - 下单时的价格) / 下单时候的价格

平仓后收益 = 余额 * 收益率 - 手续费


简化概念：

在同一条K线上 若 A时刻下单，B时刻平仓； A点 到B点 时，B点 的收益率为

(B点收盘价 - A点收盘价)/A点收盘价 * 100%


例子：

昨天股价 4 元，今天股价 5 元 ，若昨天买了股票，今天的收益率为 ：
(5-4)/4 * 100% ≈ 25%
若昨天买了 1000 元的股票，今天的收益额为  1000 * 0.33 =  250 元
则总余额 =  1000 * (1+0.25) =  1250 元

换个计算逻辑来验证：
1000 元昨天可以购买  1000 / 4  = 250 股
今天每股 5 元，全部卖出 可得    250 * 5 = 1250 元




```

## 手续费收取规则

参照 https://www.okx.com/zh-hans/fees

```txt

手续费计算公式：
现货交易手续费 = 手续费率 × 成交时买入币种的数量。

以 USDT/USD 现货为例，假设 USDT 目前价格为 10 USD；交易者 A (挂单手续费为 0.04%，吃单手续费为 0.1%) 以市价单买入 1 USDT，成交时为吃单方，需要支付的手续费 = 0.1% × 1 = 0.001 USDT，成交后将获得 0.999 USDT；

若交易者 A 以限价单卖出 1 USDT，即买入 10 USD，则成交时为挂单方，需要支付的手续费 = 0.04% × 10 = 0.004 USD，成交后将获得 9.996 USD。

```

> 买入卖出 均要支付手续费

## 手续费计算公式

```txt

若 手续费率为  0.1%

当前持有  1000 USTD 的 BTC 想要卖掉，则代表买入  1000 USDT
手续费 = 1000USDT *  0.1%   =  1USDT
成交后得到  1000USDT - 1USDT =   999 USDT


当你持有 1000USDT 想要购买 BTC,  相当于你要买入 x 个BTC
手续费 =  x BTC *  0.1%   =  a BTC
成交后得到   x BTC - a BTC =   x - a BTC

已知 xBTC = 1000USDT  则上述公式可等效为
手续费 = 1000USDT *  0.1%   =  1USDT
成交后得到  1000USDT - 1USDT =   999 USDT


简化概念：

USDT 为一般等价物，相当于价格单位
BTC 为商品，但是价格是随着时间变动的
所以在相同的时间内 （假设交易在一瞬间完成）
若 xBTC = 1000USDT

那么 x BTC  和 a BTC 的价值差 其实就是   1000USDT *  0.1%

因此无论是买入还是卖出，手续费的计算公式均可以简化为：

手续费 = 买入/卖出总金额 * 手续费率

```

## 需要实现的一些交易概念

开仓(OpenPosition)：
开仓也叫建仓，是指投资者新买入或新卖出一定数量的股指期货合约。如果投资者将这份股指期货合约保留到最后交易日，他就必须通过现金交割来了结这笔期货交易。

平仓(ClosePosition)：
平仓是指期货投资者买入或者卖出与其所持股指期货合约的品种、数量及交割月份相同但交易方向相反的股指期货合约，了结股指期货交易的行为。可以理解为落袋为安，现金结算。

持仓(Positions)：
开仓之后尚没有平仓的合约，叫做未平仓合约，也叫持仓。

## 伪代码

持仓的计算比较复杂，平仓，计算收益等有大量的公共方法和函数。
最好以面向对象的方式去进行管理：

```go
// 建立一个 action
action,err := NewPositionAction({
  StrategyID string
  MockName string
})
// action 包含交易需要 的各种信息，包括手续费率，余额等。

action.AddNewPosition
// 添加一个新的需要下单的持仓

action.OpenPosition
// 下单，开仓 , 需要参数，下单的 13 位 毫秒 时间戳。如果是实盘策略，将会忽略该时间。


action.ClosePosition
// 平仓，落袋，平仓了，计算余下金额 并 写入本地数据，做好记录。

action.ReadPositions
// 读取当前持仓状态，加上时间戳参数，可以读取任意时刻的持仓状态。

```

> 开始实现吧 ~
